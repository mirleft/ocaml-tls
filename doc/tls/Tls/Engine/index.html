<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Engine (tls.Tls.Engine)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.4"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">tls</a> &#x00BB; <a href="../index.html">Tls</a> &#x00BB; Engine</nav><header class="odoc-preamble"><h1>Module <code><span>Tls.Engine</span></code></h1><p>Transport layer security</p><p><code>TLS</code> is an implementation of <a href="https://en.wikipedia.org/wiki/Transport_Layer_Security">transport layer security</a> in OCaml. TLS is a widely used security protocol which establishes an end-to-end secure channel (with optional (mutual) authentication) between two endpoints. It uses TCP/IP as transport. This library supports all four versions of TLS: <a href="https://tools.ietf.org/html/rfc8446">1.3, RFC8446</a>, <a href="https://tools.ietf.org/html/rfc5246">1.2, RFC5246</a>, <a href="https://tools.ietf.org/html/rfc4346">1.1, RFC4346</a>, and <a href="https://tools.ietf.org/html/rfc2246">1.0, RFC2246</a>. SSL, the previous protocol definition, is not supported.</p><p>TLS is algorithmically agile: protocol version, key exchange algorithm, symmetric cipher, and message authentication code are negotiated upon connection.</p><p>This library implements several extensions of TLS, <a href="https://tools.ietf.org/html/rfc3268">AES ciphers</a>, <a href="https://tools.ietf.org/html/rfc4366">TLS extensions</a> (such as server name indication, SNI), <a href="https://tools.ietf.org/html/rfc5746">Renegotiation extension</a>, <a href="https://tools.ietf.org/html/rfc7627">Session Hash and Extended Master Secret Extension</a>.</p><p>This library does not contain insecure cipher suites (such as single DES, export ciphers, ...). It does not expose the server time in the server random, requires secure renegotiation.</p><p>This library consists of a core, implemented in a purely functional matter (<a href="#"><code>Engine</code></a>, this module), and effectful parts: <code>Tls_lwt</code> and <code>Tls_mirage</code>.</p><p><em>v2.0.0</em></p></header><nav class="odoc-toc"><ul><li><a href="#abstract-state-type">Abstract state type</a></li><li><a href="#constructors">Constructors</a></li><li><a href="#protocol-failures">Protocol failures</a></li><li><a href="#protocol-handling">Protocol handling</a></li><li><a href="#session-information">Session information</a></li></ul></nav><div class="odoc-content"><h2 id="abstract-state-type"><a href="#abstract-state-type" class="anchor"></a>Abstract state type</h2><div class="odoc-spec"><div class="spec type anchored" id="type-state"><a href="#type-state" class="anchor"></a><code><span><span class="keyword">type</span> state</span></code></div><div class="spec-doc"><p>The abstract type of a TLS state.</p></div></div><h2 id="constructors"><a href="#constructors" class="anchor"></a>Constructors</h2><div class="odoc-spec"><div class="spec value anchored" id="val-client"><a href="#val-client" class="anchor"></a><code><span><span class="keyword">val</span> client : <span><a href="../Config/index.html#type-client">Config.client</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-state">state</a> * string</span></code></div><div class="spec-doc"><p><code>client client</code> is <code>tls * out</code> where <code>tls</code> is the initial state, and <code>out</code> the initial client hello</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-server"><a href="#val-server" class="anchor"></a><code><span><span class="keyword">val</span> server : <span><a href="../Config/index.html#type-server">Config.server</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-state">state</a></span></code></div><div class="spec-doc"><p><code>server server</code> is <code>tls</code> where <code>tls</code> is the initial server state</p></div></div><h2 id="protocol-failures"><a href="#protocol-failures" class="anchor"></a>Protocol failures</h2><div class="odoc-spec"><div class="spec type anchored" id="type-error"><a href="#type-error" class="anchor"></a><code><span><span class="keyword">type</span> error</span><span> = </span><span>[ </span></code><ol><li id="type-error.AuthenticationFailure" class="def variant constructor anchored"><a href="#type-error.AuthenticationFailure" class="anchor"></a><code><span>| </span><span>`AuthenticationFailure <span class="keyword">of</span> <span class="xref-unresolved">X509</span>.Validation.validation_error</span></code></li><li id="type-error.NoConfiguredCiphersuite" class="def variant constructor anchored"><a href="#type-error.NoConfiguredCiphersuite" class="anchor"></a><code><span>| </span><span>`NoConfiguredCiphersuite <span class="keyword">of</span> <span><a href="../Ciphersuite/index.html#type-ciphersuite">Ciphersuite.ciphersuite</a> list</span></span></code></li><li id="type-error.NoConfiguredVersions" class="def variant constructor anchored"><a href="#type-error.NoConfiguredVersions" class="anchor"></a><code><span>| </span><span>`NoConfiguredVersions <span class="keyword">of</span> <span><a href="../Core/index.html#type-tls_version">Core.tls_version</a> list</span></span></code></li><li id="type-error.NoConfiguredSignatureAlgorithm" class="def variant constructor anchored"><a href="#type-error.NoConfiguredSignatureAlgorithm" class="anchor"></a><code><span>| </span><span>`NoConfiguredSignatureAlgorithm <span class="keyword">of</span> <span><a href="../Core/index.html#type-signature_algorithm">Core.signature_algorithm</a> list</span></span></code></li><li id="type-error.NoMatchingCertificateFound" class="def variant constructor anchored"><a href="#type-error.NoMatchingCertificateFound" class="anchor"></a><code><span>| </span><span>`NoMatchingCertificateFound <span class="keyword">of</span> string</span></code></li><li id="type-error.CouldntSelectCertificate" class="def variant constructor anchored"><a href="#type-error.CouldntSelectCertificate" class="anchor"></a><code><span>| </span><span>`CouldntSelectCertificate</span></code></li></ol><code><span> ]</span></code></div><div class="spec-doc"><p>failures which can be mitigated by reconfiguration</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-fatal"><a href="#type-fatal" class="anchor"></a><code><span><span class="keyword">type</span> fatal</span><span> = </span><span>[ </span></code><ol><li id="type-fatal.Protocol_version" class="def variant constructor anchored"><a href="#type-fatal.Protocol_version" class="anchor"></a><code><span>| </span><span>`Protocol_version <span class="keyword">of</span>
  <span>[ <span>`None_supported of <span><a href="../Core/index.html#type-tls_any_version">Core.tls_any_version</a> list</span></span>
  <span><span>| `Unknown_record</span> of int * int</span>
  <span><span>| `Bad_record</span> of <a href="../Core/index.html#type-tls_any_version">Core.tls_any_version</a></span> ]</span></span></code></li><li id="type-fatal.Unexpected" class="def variant constructor anchored"><a href="#type-fatal.Unexpected" class="anchor"></a><code><span>| </span><span>`Unexpected <span class="keyword">of</span>
  <span>[ <span>`Content_type of int</span>
  <span><span>| `Message</span> of string</span>
  <span><span>| `Handshake</span> of <a href="../Core/index.html#type-tls_handshake">Core.tls_handshake</a></span> ]</span></span></code></li><li id="type-fatal.Decode" class="def variant constructor anchored"><a href="#type-fatal.Decode" class="anchor"></a><code><span>| </span><span>`Decode <span class="keyword">of</span> string</span></code></li><li id="type-fatal.Handshake" class="def variant constructor anchored"><a href="#type-fatal.Handshake" class="anchor"></a><code><span>| </span><span>`Handshake <span class="keyword">of</span>
  <span>[ <span>`Message of string</span>
  <span>| `Fragments</span>
  <span><span>| `BadDH</span> of string</span>
  <span><span>| `BadECDH</span> of <span class="xref-unresolved">Mirage_crypto_ec</span>.error</span> ]</span></span></code></li><li id="type-fatal.Bad_certificate" class="def variant constructor anchored"><a href="#type-fatal.Bad_certificate" class="anchor"></a><code><span>| </span><span>`Bad_certificate <span class="keyword">of</span> string</span></code></li><li id="type-fatal.Missing_extension" class="def variant constructor anchored"><a href="#type-fatal.Missing_extension" class="anchor"></a><code><span>| </span><span>`Missing_extension <span class="keyword">of</span> string</span></code></li><li id="type-fatal.Bad_mac" class="def variant constructor anchored"><a href="#type-fatal.Bad_mac" class="anchor"></a><code><span>| </span><span>`Bad_mac</span></code></li><li id="type-fatal.Record_overflow" class="def variant constructor anchored"><a href="#type-fatal.Record_overflow" class="anchor"></a><code><span>| </span><span>`Record_overflow <span class="keyword">of</span> int</span></code></li><li id="type-fatal.Unsupported_extension" class="def variant constructor anchored"><a href="#type-fatal.Unsupported_extension" class="anchor"></a><code><span>| </span><span>`Unsupported_extension</span></code></li><li id="type-fatal.Inappropriate_fallback" class="def variant constructor anchored"><a href="#type-fatal.Inappropriate_fallback" class="anchor"></a><code><span>| </span><span>`Inappropriate_fallback</span></code></li><li id="type-fatal.No_application_protocol" class="def variant constructor anchored"><a href="#type-fatal.No_application_protocol" class="anchor"></a><code><span>| </span><span>`No_application_protocol</span></code></li></ol><code><span> ]</span></code></div><div class="spec-doc"><p>failures from received garbage or lack of features</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-failure"><a href="#type-failure" class="anchor"></a><code><span><span class="keyword">type</span> failure</span><span> = </span><span>[ </span></code><ol><li id="type-failure.Error" class="def variant constructor anchored"><a href="#type-failure.Error" class="anchor"></a><code><span>| </span><span>`Error <span class="keyword">of</span> <a href="#type-error">error</a></span></code></li><li id="type-failure.Fatal" class="def variant constructor anchored"><a href="#type-failure.Fatal" class="anchor"></a><code><span>| </span><span>`Fatal <span class="keyword">of</span> <a href="#type-fatal">fatal</a></span></code></li><li id="type-failure.Alert" class="def variant constructor anchored"><a href="#type-failure.Alert" class="anchor"></a><code><span>| </span><span>`Alert <span class="keyword">of</span> <a href="../Packet/index.html#type-alert_type">Packet.alert_type</a></span></code></li></ol><code><span> ]</span></code></div><div class="spec-doc"><p>type of failures</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-alert_of_failure"><a href="#val-alert_of_failure" class="anchor"></a><code><span><span class="keyword">val</span> alert_of_failure : <span><a href="#type-failure">failure</a> <span class="arrow">&#45;&gt;</span></span> <a href="../Packet/index.html#type-alert_level">Packet.alert_level</a> * <a href="../Packet/index.html#type-alert_type">Packet.alert_type</a></span></code></div><div class="spec-doc"><p><code>alert_of_failure failure</code> is <code>alert</code>, the TLS alert type for this failure.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-string_of_failure"><a href="#val-string_of_failure" class="anchor"></a><code><span><span class="keyword">val</span> string_of_failure : <span><a href="#type-failure">failure</a> <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p><code>string_of_failure failure</code> is <code>string</code>, the string representation of the <code>failure</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-pp_failure"><a href="#val-pp_failure" class="anchor"></a><code><span><span class="keyword">val</span> pp_failure : <span><a href="#type-failure">failure</a> <span class="xref-unresolved">Fmt</span>.t</span></span></code></div><div class="spec-doc"><p><code>pp_failure failure</code> pretty-prints failure.</p></div></div><h2 id="protocol-handling"><a href="#protocol-handling" class="anchor"></a>Protocol handling</h2><div class="odoc-spec"><div class="spec type anchored" id="type-ret"><a href="#type-ret" class="anchor"></a><code><span><span class="keyword">type</span> ret</span><span> =
  <span><span>(<a href="#type-state">state</a>
   * <span><span>[ `Eof ]</span> option</span>
   * <span>[ <span>`Response of <span>string option</span></span> ]</span>
   * <span>[ <span>`Data of <span>string option</span></span> ]</span>,
    <a href="#type-failure">failure</a> * <span>[ <span>`Response of string</span> ]</span>)</span>
    <span class="xref-unresolved">Stdlib</span>.result</span></span></code></div><div class="spec-doc"><p>result type of <a href="#val-handle_tls"><code>handle_tls</code></a>: either failed to handle the incoming buffer (<code>`Fail</code>) with <a href="#type-failure"><code>failure</code></a> and potentially a message to send to the other endpoint, or sucessful operation (<code>`Ok</code>) with a new <a href="#type-state"><code>state</code></a>, an end of file (<code>`Eof</code>), or an incoming (<code>`Alert</code>). Possibly some <code>`Response</code> to the other endpoint is needed, and potentially some <code>`Data</code> for the application was received.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-handle_tls"><a href="#val-handle_tls" class="anchor"></a><code><span><span class="keyword">val</span> handle_tls : <span><a href="#type-state">state</a> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <a href="#type-ret">ret</a></span></code></div><div class="spec-doc"><p><code>handle_tls state buffer</code> is <code>ret</code>, depending on incoming <code>state</code> and <code>buffer</code>, the result is the appropriate <a href="#type-ret"><code>ret</code></a></p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-handshake_in_progress"><a href="#val-handshake_in_progress" class="anchor"></a><code><span><span class="keyword">val</span> handshake_in_progress : <span><a href="#type-state">state</a> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p><code>handshake_in_progrss state</code> is a predicate which indicates whether there is a handshake in progress or scheduled.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-send_application_data"><a href="#val-send_application_data" class="anchor"></a><code><span><span class="keyword">val</span> send_application_data : <span><a href="#type-state">state</a> <span class="arrow">&#45;&gt;</span></span> <span><span>string list</span> <span class="arrow">&#45;&gt;</span></span> <span><span>(<a href="#type-state">state</a> * string)</span> option</span></span></code></div><div class="spec-doc"><p><code>send_application_data tls outs</code> is <code>Some (tls', out)</code> where <code>tls'</code> is the new tls state, and <code>out</code> the cstruct to send over the wire (encrypted <code>outs</code>) when the TLS session is ready. When the TLS session is not ready it is <code>None</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-send_close_notify"><a href="#val-send_close_notify" class="anchor"></a><code><span><span class="keyword">val</span> send_close_notify : <span><a href="#type-state">state</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-state">state</a> * string</span></code></div><div class="spec-doc"><p><code>send_close_notify tls</code> is <code>tls' * out</code> where <code>tls'</code> is the new tls state, and out the (possible encrypted) close notify alert.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-reneg"><a href="#val-reneg" class="anchor"></a><code><span><span class="keyword">val</span> reneg : 
  <span><span class="optlabel">?authenticator</span>:<span class="xref-unresolved">X509</span>.Authenticator.t <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?acceptable_cas</span>:<span><span class="xref-unresolved">X509</span>.Distinguished_name.t list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?cert</span>:<a href="../Config/index.html#type-own_cert">Config.own_cert</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-state">state</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<a href="#type-state">state</a> * string)</span> option</span></span></code></div><div class="spec-doc"><p><code>reneg ~authenticator ~acceptable_cas ~cert tls</code> initiates a renegotation on <code>tls</code>, using the provided <code>authenticator</code>. It is <code>tls' * out</code> where <code>tls'</code> is the new tls state, and <code>out</code> either a client hello or hello request (depending on which communication endpoint <code>tls</code> is).</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-key_update"><a href="#val-key_update" class="anchor"></a><code><span><span class="keyword">val</span> key_update : 
  <span><span class="optlabel">?request</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-state">state</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<a href="#type-state">state</a> * string, <a href="#type-failure">failure</a>)</span> <span class="xref-unresolved">Stdlib</span>.result</span></span></code></div><div class="spec-doc"><p><code>key_update ~request state</code> initiates a KeyUpdate (TLS 1.3 only). If <code>request</code> is provided and <code>true</code> (the default), the KeyUpdate message contains a request that the peer should update their traffic key as well.</p></div></div><h2 id="session-information"><a href="#session-information" class="anchor"></a>Session information</h2><div class="odoc-spec"><div class="spec value anchored" id="val-epoch"><a href="#val-epoch" class="anchor"></a><code><span><span class="keyword">val</span> epoch : <span><a href="#type-state">state</a> <span class="arrow">&#45;&gt;</span></span> <span><span>(<a href="../Core/index.html#type-epoch_data">Core.epoch_data</a>, unit)</span> <span class="xref-unresolved">Stdlib</span>.result</span></span></code></div><div class="spec-doc"><p><code>epoch state</code> is <code>epoch</code>, which contains the session information. If there's no established session yet, an error is returned.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-export_key_material"><a href="#val-export_key_material" class="anchor"></a><code><span><span class="keyword">val</span> export_key_material : 
  <span><a href="../Core/index.html#type-epoch_data">Core.epoch_data</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?context</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span>string <span class="arrow">&#45;&gt;</span></span>
  <span>int <span class="arrow">&#45;&gt;</span></span>
  string</span></code></div><div class="spec-doc"><p><code>export_key_material epoch_data ?context label length</code> is the RFC 5705 exported key material of <code>length</code> bytes using <code>label</code> and, if provided, <code>context</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-channel_binding"><a href="#val-channel_binding" class="anchor"></a><code><span><span class="keyword">val</span> channel_binding : 
  <span><a href="../Core/index.html#type-epoch_data">Core.epoch_data</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>[ `Tls_exporter <span>| `Tls_unique</span> <span>| `Tls_server_endpoint</span> ]</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(string, <span>[ <span>`Msg of string</span> ]</span>)</span> <span class="xref-unresolved">Stdlib</span>.result</span></span></code></div><div class="spec-doc"><p><code>channel_binding epoch_data mode</code> is the RFC 5929 and RFC 9266 specified channel binding. Please note that <code>`Tls_unique</code> will error for TLS 1.3 sessions, and <code>`Tls_exporter</code> is not recommended for TLS &lt; 1.3 sessions (unless the uniqueness is ensured via another path).</p></div></div></div></body></html>
